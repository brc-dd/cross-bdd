name: Test

on:
  workflow_call:
    inputs:
      deno_versions:
        type: string
      node_versions:
        type: string
      bun_versions:
        type: string

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: denoland/setup-deno@v2
      - uses: pnpm/action-setup@v4
        with:
          version: latest
      - run: |
          set -euo pipefail
          shopt -s globstar nullglob extglob

          TEST_FILES=(**/*.test.ts)

          DENO_TEST_COMMAND=(deno test -A "${TEST_FILES[@]}")
          NODE_TEST_COMMAND=(pnpx tsx --test "${TEST_FILES[@]}")
          BUN_TEST_COMMAND=(bun test "${TEST_FILES[@]}")

          TASKS="$(NO_COLOR=1 deno task 2>/dev/null || true)"

          has_task() {
            grep -qE "^- $1(\b|[[:space:]])" <<<"$TASKS"
          }

          has_task test:deno && DENO_TEST_COMMAND=(deno task test:deno)
          has_task test:node && NODE_TEST_COMMAND=(deno task test:node)
          has_task test:bun && BUN_TEST_COMMAND=(deno task test:bun)

          if [ -f "deno.json" ]; then
            deno install
            has_task build && deno task build
            has_task check:only && deno task check:only
            if [ ! -f "package.json" ]; then
              echo '{ "type": "module" }' >package.json
            fi
          elif [ -f "package.json" ]; then
            pnpm install
            has_task build && pnpm build
            has_task check:only && pnpm check:only
            if [ ! -f "deno.json" ]; then
              echo '{ "imports": {} }' >deno.json
            fi
          else
            echo 'Could not find deno.json or package.json. Please ensure at least one exists.'
            exit 1
          fi

          NPM_DEPS=$(jq -r '.imports | to_entries[] | select(.value | startswith("npm:")) | .value[4:]' deno.json)
          JSR_DEPS=$(jq -r '.imports | to_entries[] | select(.value | startswith("jsr:")) | .value' deno.json)

          if [ -d "./dist" ]; then
            (cd dist && pnpm pack --out=pkg.tgz)
            NPM_DEPS="./dist/pkg.tgz $NPM_DEPS"
          fi

          for version in ${{ inputs.deno_versions }}; do
            echo "Testing on Deno version $version"
            deno upgrade ${version}
            deno -v
            deno install
            "${DENO_TEST_COMMAND[@]}"
          done

          for version in ${{ inputs.node_versions }}; do
            echo "Testing on Node.js version $version"
            pnpm env use --global ${version}
            node -v
            if [ -n "$NPM_DEPS" ] || [ -n "$JSR_DEPS" ]; then
              pnpm add $NPM_DEPS $JSR_DEPS
            fi
            pnpm install
            "${NODE_TEST_COMMAND[@]}"
          done

          for version in ${{ inputs.bun_versions }}; do
            echo "Testing on Bun version $version"
            pnpm add --dangerously-allow-all-builds -g bun@${version}
            bun -v
            if [ -n "$NPM_DEPS" ]; then
              bun add $NPM_DEPS
            fi
            if [ -n "$JSR_DEPS" ]; then
              bun x jsr add $(echo $JSR_DEPS | sed 's/^jsr://')
            fi
            bun install
            "${BUN_TEST_COMMAND[@]}"
          done
